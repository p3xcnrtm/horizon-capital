<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deposit | Horizon Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    body {
      padding-top: 72px;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .wrapper { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 20px 16px; 
    }
    .card { 
      background: #fff; 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
    }
    h1 { 
      margin: 0 0 16px 0; 
      font-size: 24px; 
      color: var(--text-dark); 
      font-weight: 700;
    }
    label { 
      display: block; 
      margin: 12px 0 6px; 
      font-weight: 600; 
      color: var(--text-dark);
      font-size: 0.9rem;
    }
    input, select { 
      width: 100%; 
      padding: 12px 14px; 
      border: 1px solid #cbd5e1; 
      border-radius: 10px; 
      font-size: 16px; 
      outline: none; 
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
    }
    .btn { 
      margin-top: 16px; 
      background: var(--primary-gradient); 
      color: #fff; 
      border: 0; 
      padding: 14px 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 600; 
      width: 100%; 
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tip { 
      color: var(--text-gray); 
      font-size: 13px; 
      margin-top: 6px; 
    }
    .copy-btn { 
      margin-left: 8px; 
      padding: 6px 12px; 
      font-size: 12px; 
      border: 1px solid #cbd5e1; 
      background: #fff; 
      border-radius: 6px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .copy-btn:hover { 
      background: #f1f5f9; 
      border-color: var(--primary-color);
    }
    #bankPanel, #cryptoPanel {
      margin-top: 18px; 
      padding: 16px; 
      border: 1px solid #e2e8f0; 
      border-radius: 10px; 
      background: #f8fafc; 
    }
    #bankPanel h2, #cryptoPanel h2 {
      margin: 0 0 12px 0; 
      font-size: 16px; 
      color: var(--text-dark); 
      font-weight: 600;
    }
    code {
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      word-break: break-all;
    }
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 16px;
      padding: 16px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    .qr-code-container canvas {
      border-radius: 8px;
      padding: 8px;
      background: #fff;
    }
    .qr-code-label {
      margin-top: 12px;
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 600;
    }
    @media (max-width: 768px) {
      .wrapper {
        padding: 16px 12px;
      }
      .card {
        padding: 20px;
      }
      .row {
        grid-template-columns: 1fr;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-brand">HORIZON</a>
      <ul class="navbar-menu">
        <li><a href="index.html" class="navbar-link">Home</a></li>
        <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="real-estate.html" class="navbar-link">Real Estate</a></li>
        <li><a href="stocks.html" class="navbar-link">Stocks</a></li>
        <li><a href="bonds.html" class="navbar-link">Bonds</a></li>
        <li><a href="crypto.html" class="navbar-link">Crypto</a></li>
        <li><button onclick="logout()" class="navbar-btn btn-danger" style="padding: 0.5rem 1.25rem; font-size: 0.875rem;">Logout</button></li>
      </ul>
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i data-feather="menu"></i>
      </button>
    </div>
  </nav>

  <div class="wrapper">
    <div class="card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h1 style="margin: 0;">Deposit Funds</h1>
        <a href="dashboard.html" style="display: flex; align-items: center; gap: 6px; color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.9rem;">
          <i data-feather="arrow-left" style="width: 16px; height: 16px;"></i>
          <span>Back to Dashboard</span>
        </a>
      </div>
      
      <!-- Plan Selection Notice -->
      <div id="planNotice" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 10px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i data-feather="info" style="width: 20px; height: 20px;"></i>
          <strong style="font-size: 1rem;">Investment Plan Selected</strong>
        </div>
        <p id="planNoticeText" style="margin: 0; font-size: 0.9rem; opacity: 0.95;"></p>
      </div>

      <form id="depositForm" novalidate onsubmit="handleDeposit(event); return false;">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="you@example.com" required />
        <div class="tip">Use the email associated with your Horizon account.</div>

        <div class="row">
          <div>
            <label for="amount">Amount</label>
            <input type="number" step="0.01" min="1" id="amount" name="amount" placeholder="1000" required />
          </div>
          <div>
            <label for="currency">Currency</label>
            <select id="currency" name="currency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
        </div>

        <label for="method">Payment Method</label>
        <select id="method" name="method" required>
          <option value="">Select a method</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="crypto">Crypto</option>
        </select>

        <div id="methodHelp" class="tip">Choose Bank Transfer or Crypto. Card deposits are not available.</div>

        <!-- Crypto network (only visible when method = crypto) -->
        <div id="cryptoNetworkRow" class="row" style="display:none; margin-top:4px;">
          <div style="grid-column: 1 / -1;">
            <label for="cryptoNetwork">Crypto Network</label>
            <select id="cryptoNetwork" name="crypto_network">
              <option value="">Select network</option>
              <option value="TRC20">USDT (TRC20)</option>
              <option value="BTC">BTC (SegWit)</option>
              <option value="ERC20">ETH (ERC20)</option>
            </select>
            <div class="tip">When depositing crypto, include the selected network (e.g., TRC20, BTC, ERC20) in the Reference field below.</div>
          </div>
        </div>

        <div id="bankPanel" style="display:none; margin-top:18px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
          <h2 style="margin:0 0 8px 0; font-size:16px; color:#0a3d62;">Bank Transfer Details</h2>
          <div style="font-size:14px; line-height:1.6; color:#334155;">
            <div><strong>Bank Name:</strong> Horizon Capital Custody</div>
            <div><strong>Account Name:</strong> Horizon Capital LLC</div>
            <div><strong>Account Number:</strong> <code id="acctNumber">1234567890</code> <button type="button" class="copy-btn" data-copy="acctNumber">Copy</button></div>
            <div><strong>IBAN:</strong> <code id="iban">GB12 BARC 1234 5678 9012 34</code> <button type="button" class="copy-btn" data-copy="iban">Copy</button></div>
            <div><strong>SWIFT/BIC:</strong> <code id="swift">BARCGB22</code> <button type="button" class="copy-btn" data-copy="swift">Copy</button></div>
            <div class="tip">Include your email or the reference code below in the transfer memo for faster reconciliation.</div>
          </div>
        </div>

        <div id="cryptoPanel" style="display:none; margin-top:12px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
          <h2 style="margin:0 0 8px 0; font-size:16px; color:#0a3d62;">Crypto Wallet Addresses</h2>
          <div style="font-size:14px; line-height:1.6; color:#334155;">
            <div class="addr-row" data-network="TRC20" style="display:none;"><strong>USDT (TRC20):</strong> <code id="usdtTrc20">TV8XexampleTronAddress12345</code> <button type="button" class="copy-btn" data-copy="usdtTrc20">Copy</button></div>
            <div class="addr-row" data-network="BTC" style="display:none;"><strong>BTC (SegWit):</strong> <code id="btcSegwit">bc1qexamplebtcaddress000000000</code> <button type="button" class="copy-btn" data-copy="btcSegwit">Copy</button></div>
            <div class="addr-row" data-network="ERC20" style="display:none;"><strong>ETH (ERC20):</strong> <code id="ethErc20">0x1234567890abcdef1234567890abcdef12345678</code> <button type="button" class="copy-btn" data-copy="ethErc20">Copy</button></div>
            <div class="tip">Send only on the correct network (e.g., TRC20 for USDT TRC20). Network or token mismatches may result in loss of funds.</div>
          </div>
          <!-- QR Code Container -->
          <div id="qrCodeContainer" class="qr-code-container" style="display:none;">
            <canvas id="qrCodeCanvas" width="200" height="200"></canvas>
            <div class="qr-code-label">Scan to copy wallet address</div>
          </div>
        </div>

        <label for="reference">Reference (optional)</label>
        <input type="text" id="reference" name="reference" placeholder="Transaction reference" />

        <button class="btn" type="submit">Submit Deposit</button>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const methodEl = document.getElementById('method');
      const helpEl = document.getElementById('methodHelp');
      const bankPanel = document.getElementById('bankPanel');
      const cryptoPanel = document.getElementById('cryptoPanel');
      const cryptoNetworkRow = document.getElementById('cryptoNetworkRow');
      const cryptoNetworkEl = document.getElementById('cryptoNetwork');
      const form = document.getElementById('depositForm');

      function updatePanels() {
        const val = methodEl.value;
        if (val === 'bank_transfer') {
          bankPanel.style.display = '';
          cryptoPanel.style.display = 'none';
          cryptoNetworkRow.style.display = 'none';
          helpEl.textContent = 'You selected Bank Transfer. Use the details below and include your email or reference in the memo.';
        } else if (val === 'crypto') {
          bankPanel.style.display = 'none';
          cryptoPanel.style.display = '';
          cryptoNetworkRow.style.display = '';
          helpEl.textContent = 'You selected Crypto. Choose the correct network and include it in the Reference field.';
        } else {
          bankPanel.style.display = 'none';
          cryptoPanel.style.display = 'none';
          cryptoNetworkRow.style.display = 'none';
          helpEl.textContent = 'Choose Bank Transfer or Crypto. Card deposits are not available.';
        }
      }

      methodEl.addEventListener('change', updatePanels);
      updatePanels();

      // Copy buttons
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-copy');
          const el = document.getElementById(id);
          if (!el) return;
          const text = el.textContent.trim();
          navigator.clipboard.writeText(text).then(() => {
            const old = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(() => { btn.textContent = old; }, 1200);
          });
        });
      });

      // Client validation: when crypto, ensure reference contains selected network keyword
      form.addEventListener('submit', (e) => {
        if (methodEl.value === 'crypto') {
          const net = (cryptoNetworkEl.value || '').trim();
          if (!net) {
            e.preventDefault();
            alert('Please select a Crypto Network.');
            return;
          }
          const ref = (document.getElementById('reference').value || '').toUpperCase();
          if (!ref.includes(net)) {
            e.preventDefault();
            alert('Reference must include the selected network keyword: ' + net + '.');
            return;
          }
        }
      });
      
      // Show only selected crypto address and generate QR code
      function updateCryptoAddresses() {
        const net = (cryptoNetworkEl.value || '').trim();
        const qrContainer = document.getElementById('qrCodeContainer');
        const qrCanvas = document.getElementById('qrCodeCanvas');
        let walletAddress = '';
        let networkName = '';
        
        // Debug logging
        console.log('updateCryptoAddresses called:', { net, method: methodEl.value });
        
        if (!qrContainer || !qrCanvas) {
          console.error('QR code container or canvas not found');
          return;
        }
        
        document.querySelectorAll('#cryptoPanel .addr-row').forEach(row => {
          const isVisible = row.getAttribute('data-network') === net && methodEl.value === 'crypto';
          row.style.display = isVisible ? '' : 'none';
          
          if (isVisible) {
            // Get the wallet address from the code element
            const codeEl = row.querySelector('code');
            if (codeEl) {
              walletAddress = codeEl.textContent.trim();
              console.log('Found wallet address:', walletAddress);
              // Get network name from the row text
              const strongEl = row.querySelector('strong');
              if (strongEl) {
                networkName = strongEl.textContent.replace(':', '').trim();
              }
            }
          }
        });
        
        // Generate QR code if wallet address is available
        if (walletAddress && methodEl.value === 'crypto' && net) {
          console.log('Attempting to generate QR code...');
          
          // Check if QRCode library is loaded
          if (typeof QRCode === 'undefined') {
            console.warn('QRCode library not loaded, retrying...');
            setTimeout(updateCryptoAddresses, 200);
            return;
          }
          
          console.log('QRCode library is available');
          qrContainer.style.display = 'flex';
          
          // Clear canvas before generating new QR code
          if (qrCanvas.width && qrCanvas.height) {
            const ctx = qrCanvas.getContext('2d');
            ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
          }
          
          try {
            QRCode.toCanvas(qrCanvas, walletAddress, {
              width: 200,
              margin: 2,
              color: {
                dark: '#0a3d62',
                light: '#ffffff'
              }
            }, function (error) {
              if (error) {
                console.error('QR code generation error:', error);
                qrContainer.style.display = 'none';
              } else {
                console.log('QR code generated successfully for:', walletAddress);
              }
            });
          } catch (error) {
            console.error('Error generating QR code:', error);
            qrContainer.style.display = 'none';
          }
        } else {
          console.log('QR code conditions not met:', { walletAddress: !!walletAddress, method: methodEl.value, net: !!net });
          qrContainer.style.display = 'none';
        }
      }
      cryptoNetworkEl.addEventListener('change', updateCryptoAddresses);
      methodEl.addEventListener('change', updateCryptoAddresses);
      
      // Wait for QRCode library to load before initial call
      function waitForQRCode() {
        if (typeof QRCode !== 'undefined') {
          updateCryptoAddresses();
        } else {
          setTimeout(waitForQRCode, 100);
        }
      }
      waitForQRCode();
    })();

    function handleDeposit(event) {
      event.preventDefault();
      const currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }

      const formData = new FormData(event.target);
      const amount = parseFloat(formData.get('amount'));
      const userData = JSON.parse(currentUser);

      userData.profits = (parseFloat(userData.profits || 0) + amount).toFixed(2);
      localStorage.setItem('currentUser', JSON.stringify(userData));

      // Check if there's a selected plan to enroll
      const selectedPlan = localStorage.getItem('selectedPlan');
      if (selectedPlan) {
        const plan = JSON.parse(selectedPlan);
        
        // Check if user has enough balance for the plan
        const balance = parseFloat(userData.profits || 0);
        if (balance >= plan.monthlyAmount) {
          // Enroll user in the plan
          userData.investmentPlan = {
            type: plan.type,
            name: plan.name,
            monthlyAmount: plan.monthlyAmount,
            startDate: new Date().toISOString(),
            status: 'active'
          };
          
          // Deduct first month's investment
          userData.profits = (balance - plan.monthlyAmount).toFixed(2);
          localStorage.setItem('currentUser', JSON.stringify(userData));
          
          // Remove selected plan from localStorage
          localStorage.removeItem('selectedPlan');
          
          alert(`Deposit successful! You have been automatically enrolled in the ${plan.name} plan.\n\nYour first monthly investment of $${plan.monthlyAmount.toLocaleString()} has been processed.`);
        } else {
          alert(`Deposit successful! However, you need at least $${plan.monthlyAmount.toLocaleString()} to enroll in the ${plan.name} plan. Your current balance is $${balance.toLocaleString()}. Please deposit more funds.`);
        }
      } else {
        alert('Deposit request submitted successfully!');
      }
      
      window.location.href = 'dashboard.html';
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    }
    
    function toggleMobileMenu() {
      const menu = document.querySelector('.navbar-menu');
      menu.classList.toggle('active');
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      feather.replace();
      
      // Check for selected plan from URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const planType = urlParams.get('plan');
      const planAmount = urlParams.get('amount');
      
      let selectedPlan = null;
      if (planType && planAmount) {
        // Get plan from URL params
        const planName = planType === 'conservative' ? 'Conservative Growth' : 'Aggressive Growth';
        selectedPlan = {
          type: planType,
          name: planName,
          monthlyAmount: parseFloat(planAmount)
        };
        localStorage.setItem('selectedPlan', JSON.stringify(selectedPlan));
      } else {
        // Check localStorage
        const storedPlan = localStorage.getItem('selectedPlan');
        if (storedPlan) {
          selectedPlan = JSON.parse(storedPlan);
        }
      }
      
      // If plan is selected, show notice and pre-fill amount
      if (selectedPlan) {
        const notice = document.getElementById('planNotice');
        const noticeText = document.getElementById('planNoticeText');
        const amountInput = document.getElementById('amount');
        
        notice.style.display = 'block';
        noticeText.textContent = `You selected the ${selectedPlan.name} plan. Please deposit at least $${selectedPlan.monthlyAmount.toLocaleString()} to enroll.`;
        amountInput.value = selectedPlan.monthlyAmount;
        amountInput.min = selectedPlan.monthlyAmount;
        
        // Add a note below the amount field
        const amountContainer = amountInput.closest('.row') || amountInput.parentElement;
        const tip = document.createElement('div');
        tip.className = 'tip';
        tip.style.color = '#667eea';
        tip.style.fontWeight = '600';
        tip.style.marginTop = '8px';
        tip.textContent = `Minimum required: $${selectedPlan.monthlyAmount.toLocaleString()} for ${selectedPlan.name} plan`;
        amountContainer.appendChild(tip);
      }
      
      // Re-render icons after dynamic content
      setTimeout(() => feather.replace(), 100);
    });
  </script>
<script src="page-transitions.js"></script>
</body>
</html>
