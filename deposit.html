<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deposit | Horizon Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    body {
      padding-top: 72px;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .wrapper { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 20px 16px; 
    }
    .card { 
      background: #fff; 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
    }
    h1 { 
      margin: 0 0 16px 0; 
      font-size: 24px; 
      color: var(--text-dark); 
      font-weight: 700;
    }
    label { 
      display: block; 
      margin: 12px 0 6px; 
      font-weight: 600; 
      color: var(--text-dark);
      font-size: 0.9rem;
    }
    input, select { 
      width: 100%; 
      padding: 12px 14px; 
      border: 1px solid #cbd5e1; 
      border-radius: 10px; 
      font-size: 16px; 
      outline: none; 
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
    }
    .btn { 
      margin-top: 16px; 
      background: var(--primary-gradient); 
      color: #fff; 
      border: 0; 
      padding: 14px 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 600; 
      width: 100%; 
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tip { 
      color: var(--text-gray); 
      font-size: 13px; 
      margin-top: 6px; 
    }
    .copy-btn { 
      margin-left: 8px; 
      padding: 6px 12px; 
      font-size: 12px; 
      border: 1px solid #cbd5e1; 
      background: #fff; 
      border-radius: 6px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .copy-btn:hover { 
      background: #f1f5f9; 
      border-color: var(--primary-color);
    }
    #bankPanel, #cryptoPanel {
      margin-top: 18px; 
      padding: 16px; 
      border: 1px solid #e2e8f0; 
      border-radius: 10px; 
      background: #f8fafc; 
    }
    #bankPanel h2, #cryptoPanel h2 {
      margin: 0 0 12px 0; 
      font-size: 16px; 
      color: var(--text-dark); 
      font-weight: 600;
    }
    code {
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      word-break: break-all;
    }
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 16px;
      padding: 16px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    .qr-code-container #qrCodeDisplay {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .qr-code-container #qrCodeDisplay img {
      border-radius: 8px;
      padding: 8px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qr-code-label {
      margin-top: 12px;
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 600;
    }
    @media (max-width: 768px) {
      .wrapper {
        padding: 16px 12px;
      }
      .card {
        padding: 20px;
      }
      .row {
        grid-template-columns: 1fr;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-brand">HORIZON</a>
      <ul class="navbar-menu">
        <li><a href="index.html" class="navbar-link">Home</a></li>
        <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="real-estate.html" class="navbar-link">Real Estate</a></li>
        <li><a href="stocks.html" class="navbar-link">Stocks</a></li>
        <li><a href="bonds.html" class="navbar-link">Bonds</a></li>
        <li><a href="crypto.html" class="navbar-link">Crypto</a></li>
        <li><button onclick="logout()" class="navbar-btn btn-danger" style="padding: 0.5rem 1.25rem; font-size: 0.875rem;">Logout</button></li>
      </ul>
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i data-feather="menu"></i>
      </button>
    </div>
  </nav>

  <div class="wrapper">
    <div class="card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h1 style="margin: 0;">Deposit Funds</h1>
        <a href="dashboard.html" style="display: flex; align-items: center; gap: 6px; color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.9rem;">
          <i data-feather="arrow-left" style="width: 16px; height: 16px;"></i>
          <span>Back to Dashboard</span>
        </a>
      </div>
      
      <!-- Plan Selection Notice -->
      <div id="planNotice" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 10px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i data-feather="info" style="width: 20px; height: 20px;"></i>
          <strong style="font-size: 1rem;">Investment Plan Selected</strong>
        </div>
        <p id="planNoticeText" style="margin: 0; font-size: 0.9rem; opacity: 0.95;"></p>
      </div>

      <form id="depositForm" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="you@example.com" required />
        <div class="tip">Use the email associated with your Horizon account.</div>

        <div class="row">
          <div>
            <label for="amount">Amount</label>
            <input type="number" step="0.01" min="1" id="amount" name="amount" placeholder="1000" required />
          </div>
          <div>
            <label for="currency">Currency</label>
            <select id="currency" name="currency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
        </div>

        <label for="method">Payment Method</label>
        <select id="method" name="method" required>
          <option value="">Select a method</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="crypto">Crypto</option>
        </select>

        <div id="methodHelp" class="tip">Choose Bank Transfer or Crypto. Card deposits are not available.</div>

        <!-- Crypto network (only visible when method = crypto) -->
        <div id="cryptoNetworkRow" class="row" style="display:none; margin-top:4px;">
          <div style="grid-column: 1 / -1;">
            <label for="cryptoNetwork">Crypto Network</label>
            <select id="cryptoNetwork" name="crypto_network">
              <option value="">Select network</option>
              <option value="TRC20">USDT (TRC20)</option>
              <option value="BTC">BTC (SegWit)</option>
              <option value="ERC20">ETH (ERC20)</option>
            </select>
          </div>
        </div>

        <div id="bankPanel" style="display:none; margin-top:18px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
          <h2 style="margin:0 0 8px 0; font-size:16px; color:#0a3d62;">Bank Transfer Details</h2>
          <div style="font-size:14px; line-height:1.6; color:#334155;">
            <div><strong>Bank Name:</strong> Horizon Capital Custody</div>
            <div><strong>Account Name:</strong> Horizon Capital LLC</div>
            <div><strong>Account Number:</strong> <code id="acctNumber">1234567890</code> <button type="button" class="copy-btn" data-copy="acctNumber">Copy</button></div>
            <div><strong>IBAN:</strong> <code id="iban">GB12 BARC 1234 5678 9012 34</code> <button type="button" class="copy-btn" data-copy="iban">Copy</button></div>
            <div><strong>SWIFT/BIC:</strong> <code id="swift">BARCGB22</code> <button type="button" class="copy-btn" data-copy="swift">Copy</button></div>
          </div>
        </div>

        <div id="cryptoPanel" style="display:none; margin-top:12px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
          <h2 style="margin:0 0 8px 0; font-size:16px; color:#0a3d62;">Crypto Wallet Addresses</h2>
          <div style="font-size:14px; line-height:1.6; color:#334155;">
            <div class="addr-row" data-network="TRC20" style="display:none;"><strong>USDT (TRC20):</strong> <code id="usdtTrc20">TQTuusHXY85QRijQK93t6oM8p4bpx1b22w</code> <button type="button" class="copy-btn" data-copy="usdtTrc20">Copy</button></div>
            <div class="addr-row" data-network="BTC" style="display:none;"><strong>BTC (SegWit):</strong> <code id="btcSegwit">bc1qexamplebtcaddress000000000</code> <button type="button" class="copy-btn" data-copy="btcSegwit">Copy</button></div>
            <div class="addr-row" data-network="ERC20" style="display:none;"><strong>ETH (ERC20):</strong> <code id="ethErc20">0x1234567890abcdef1234567890abcdef12345678</code> <button type="button" class="copy-btn" data-copy="ethErc20">Copy</button></div>
            <div class="tip">Send only on the correct network (e.g., TRC20 for USDT TRC20). Network or token mismatches may result in loss of funds.</div>
          </div>
          <!-- QR Code Container -->
          <div id="qrCodeContainer" class="qr-code-container" style="display:none;">
            <div id="qrCodeDisplay"></div>
            <div class="qr-code-label">Scan to copy wallet address</div>
          </div>
        </div>

        <button class="btn" type="submit">Submit Deposit</button>
      </form>
    </div>
  </div>
  <script>
    (function(){
      // Wait for DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
      function init() {
      const methodEl = document.getElementById('method');
      const helpEl = document.getElementById('methodHelp');
      const bankPanel = document.getElementById('bankPanel');
      const cryptoPanel = document.getElementById('cryptoPanel');
      const cryptoNetworkRow = document.getElementById('cryptoNetworkRow');
      const cryptoNetworkEl = document.getElementById('cryptoNetwork');
      const form = document.getElementById('depositForm');

        if (!form) {
          console.error('Deposit form not found!');
          return;
        }

      function updatePanels() {
          if (!methodEl) return;
        const val = methodEl.value;
        if (val === 'bank_transfer') {
            if (bankPanel) bankPanel.style.display = '';
            if (cryptoPanel) cryptoPanel.style.display = 'none';
            if (cryptoNetworkRow) cryptoNetworkRow.style.display = 'none';
            if (helpEl) helpEl.textContent = 'You selected Bank Transfer. Use the details below and include your email or reference in the memo.';
        } else if (val === 'crypto') {
            if (bankPanel) bankPanel.style.display = 'none';
            if (cryptoPanel) cryptoPanel.style.display = '';
            if (cryptoNetworkRow) cryptoNetworkRow.style.display = '';
            if (helpEl) helpEl.textContent = 'You selected Crypto. Choose the correct network and include it in the Reference field.';
        } else {
            if (bankPanel) bankPanel.style.display = 'none';
            if (cryptoPanel) cryptoPanel.style.display = 'none';
            if (cryptoNetworkRow) cryptoNetworkRow.style.display = 'none';
            if (helpEl) helpEl.textContent = 'Choose Bank Transfer or Crypto. Card deposits are not available.';
          }
        }

        if (methodEl) {
      methodEl.addEventListener('change', updatePanels);
      updatePanels();
        }

      // Copy buttons
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-copy');
          const el = document.getElementById(id);
          if (!el) return;
          const text = el.textContent.trim();
          navigator.clipboard.writeText(text).then(() => {
            const old = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(() => { btn.textContent = old; }, 1200);
          });
        });
      });

        // Crypto address updates and QR code
      function updateCryptoAddresses() {
          const methodEl = document.getElementById('method');
          const cryptoNetworkEl = document.getElementById('cryptoNetwork');
          const net = (cryptoNetworkEl?.value || '').trim();
        const qrContainer = document.getElementById('qrCodeContainer');
        const qrDisplay = document.getElementById('qrCodeDisplay');
        let walletAddress = '';
        let networkName = '';
        
        if (!qrContainer || !qrDisplay) {
          return;
        }
        
        // Show/hide address rows and get the selected wallet address
        document.querySelectorAll('#cryptoPanel .addr-row').forEach(row => {
            const isVisible = row.getAttribute('data-network') === net && methodEl?.value === 'crypto';
          row.style.display = isVisible ? '' : 'none';
          
          if (isVisible) {
            const codeEl = row.querySelector('code');
            if (codeEl) {
              walletAddress = codeEl.textContent.trim();
              const strongEl = row.querySelector('strong');
              if (strongEl) {
                networkName = strongEl.textContent.replace(':', '').trim();
              }
            }
          }
        });
        
        // Generate QR code if wallet address is available
          if (walletAddress && methodEl?.value === 'crypto' && net) {
          qrContainer.style.display = 'flex';
          
          // Use QR Server API for reliable QR code generation
          const qrSize = 200;
          const encodedAddress = encodeURIComponent(walletAddress);
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodedAddress}&bgcolor=ffffff&color=0a3d62&margin=2`;
          
          // Clear previous QR code
          qrDisplay.innerHTML = '';
          
          // Create and display QR code image
          const qrImg = document.createElement('img');
          qrImg.src = qrUrl;
          qrImg.alt = `QR Code for ${networkName} wallet address`;
          qrImg.style.width = qrSize + 'px';
          qrImg.style.height = qrSize + 'px';
          qrImg.style.borderRadius = '8px';
          qrImg.style.display = 'block';
          qrImg.onerror = function() {
            console.error('Failed to load QR code image');
            qrContainer.style.display = 'none';
          };
          qrImg.onload = function() {
            console.log('QR code loaded successfully for:', walletAddress);
          };
          
          qrDisplay.appendChild(qrImg);
        } else {
          qrContainer.style.display = 'none';
        }
      }
      
        // Crypto address updates
        if (cryptoNetworkEl) {
      cryptoNetworkEl.addEventListener('change', updateCryptoAddresses);
        }
        if (methodEl) {
      methodEl.addEventListener('change', updateCryptoAddresses);
        }
      
      // Initial call
      updateCryptoAddresses();

        // Form submission handler
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Basic validation
          const amountInput = document.getElementById('amount');
          if (!amountInput) {
            alert('Amount field not found. Please refresh the page.');
            return;
          }
          
          const amount = parseFloat(amountInput.value);
          
          if (!amount || amount <= 0 || isNaN(amount)) {
            alert('Please enter a valid deposit amount.');
            return;
          }
          
          // Validate payment method
          if (!methodEl || !methodEl.value) {
            alert('Please select a payment method.');
            return;
          }
          
          // Validate crypto network if crypto is selected
          if (methodEl.value === 'crypto') {
            const net = (cryptoNetworkEl?.value || '').trim();
            if (!net) {
              alert('Please select a Crypto Network.');
              return;
            }
          }
          
          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn?.textContent;
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
          }
          
          try {
            // Wait for Supabase to be available
            if (!window.supabase) {
              let attempts = 0;
              while (!window.supabase && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
              }
            }
            
            // Call handleDeposit function
            await handleDeposit(e);
          } catch (error) {
            console.error('Error in form submission:', error);
            alert('An error occurred: ' + (error.message || 'Unknown error'));
          } finally {
            // Restore button
            if (submitBtn) {
              submitBtn.disabled = false;
              if (originalText) submitBtn.textContent = originalText;
            }
          }
        });
        
        console.log('Form handler attached successfully');
      }
    })();

    async function handleDeposit(event) {
      if (event) event.preventDefault();
      
      if (!window.supabase) {
        alert('System is initializing. Please wait a moment and try again.');
        return;
      }

      const form = document.getElementById('depositForm');
      if (!form) {
        alert('Form not found. Please refresh the page.');
        return;
      }

      const formData = new FormData(form);
      const amount = parseFloat(formData.get('amount'));

      if (!amount || amount <= 0 || isNaN(amount)) {
        alert('Please enter a valid deposit amount.');
        return;
      }

      try {
        const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
        
        if (sessionError || !session?.user) {
          alert('Please login first');
          window.location.href = 'login.html';
          return;
        }

        // Get current profile - fetch fresh data with robust error handling
        let currentProfile = {
          profits: 0,
          btc: 0, eth: 0, dodge: 0, usdt: 0, xlm: 0, xrp: 0, shiba: 0, ltc: 0
        };

        try {
          const { data: profileData, error: fetchError } = await window.supabase
            .from('profiles')
            .select('profits,investment_plan,btc,eth,dodge,usdt,xlm,xrp,shiba,ltc')
            .eq('id', session.user.id)
            .single();

          if (fetchError) {
            // If profile doesn't exist (PGRST116), create it
            if (fetchError.code === 'PGRST116' || fetchError.message?.includes('No rows')) {
              console.log('Profile not found, creating new profile...');
              try {
                const { data: newProfile, error: createError } = await window.supabase
                  .from('profiles')
                  .insert({
                    id: session.user.id,
                    profits: 0,
                    btc: 0, eth: 0, dodge: 0, usdt: 0, xlm: 0, xrp: 0, shiba: 0, ltc: 0
                  })
                  .select()
                  .single();
                
                if (createError) {
                  console.warn('Could not create profile (may already exist):', createError.message);
                  // Profile might have been created by another process, try fetching again
                  const { data: retryData } = await window.supabase
                    .from('profiles')
                    .select('profits,investment_plan,btc,eth,dodge,usdt,xlm,xrp,shiba,ltc')
                    .eq('id', session.user.id)
                    .single();
                  
                  if (retryData) {
                    currentProfile = retryData;
                  }
                } else {
                  currentProfile = newProfile || currentProfile;
                  console.log('New profile created successfully');
                }
              } catch (createErr) {
                console.warn('Profile creation attempt failed:', createErr);
                // Continue with default profile
              }
            } else {
              // Other errors - log but continue with default profile
              console.warn('Profile query error:', fetchError.message, fetchError.code);
            }
          } else if (profileData) {
            // Successfully loaded profile
            currentProfile = profileData;
            console.log('Profile loaded successfully');
          }
        } catch (e) {
          console.warn('Profile fetch exception (using defaults):', e);
          // Continue with default profile
        }
        
        // Ensure all fields have default values (handle null/undefined)
        if (currentProfile.profits === null || currentProfile.profits === undefined) {
          currentProfile.profits = 0;
        }
        if (currentProfile.btc === null || currentProfile.btc === undefined) currentProfile.btc = 0;
        if (currentProfile.eth === null || currentProfile.eth === undefined) currentProfile.eth = 0;
        if (currentProfile.dodge === null || currentProfile.dodge === undefined) currentProfile.dodge = 0;
        if (currentProfile.usdt === null || currentProfile.usdt === undefined) currentProfile.usdt = 0;
        if (currentProfile.xlm === null || currentProfile.xlm === undefined) currentProfile.xlm = 0;
        if (currentProfile.xrp === null || currentProfile.xrp === undefined) currentProfile.xrp = 0;
        if (currentProfile.shiba === null || currentProfile.shiba === undefined) currentProfile.shiba = 0;
        if (currentProfile.ltc === null || currentProfile.ltc === undefined) currentProfile.ltc = 0;

        const currentBalance = parseFloat(currentProfile?.profits || 0);
        const newBalance = currentBalance + amount;

      // Check if there's a selected plan to enroll
        const selectedPlanStr = localStorage.getItem('selectedPlan');
        let plan = null;
        if (selectedPlanStr) {
          try {
            plan = JSON.parse(selectedPlanStr);
          } catch (e) {
            console.warn('Error parsing selected plan:', e);
          }
        }

        // Build update data - always include all asset fields to preserve existing values
        const updateData = {
          profits: newBalance
        };
        
        // Preserve existing asset values if not being updated
        ['btc', 'eth', 'dodge', 'usdt', 'xlm', 'xrp', 'shiba', 'ltc'].forEach(asset => {
          updateData[asset] = parseFloat(currentProfile[asset]) || 0;
        });

        // If plan is selected and user has enough balance, enroll and allocate assets
        if (plan && newBalance >= plan.monthlyAmount) {
          const investmentAmount = plan.monthlyAmount;
          const remainingBalance = newBalance - investmentAmount;
          
          // Calculate asset allocation
          const assetAllocation = await calculateAssetAllocation(plan.type, investmentAmount);
          
          updateData.profits = remainingBalance;
          updateData.investment_plan = JSON.stringify({
            type: plan.type,
            name: plan.name,
            monthlyAmount: plan.monthlyAmount,
            startDate: new Date().toISOString(),
            status: 'active'
          });
          
          // Add allocated assets to existing holdings
          Object.keys(assetAllocation).forEach(asset => {
            const currentQty = parseFloat(currentProfile[asset] || 0);
            updateData[asset] = (currentQty || 0) + (parseFloat(assetAllocation[asset]) || 0);
          });

          localStorage.removeItem('selectedPlan');
          alert(`Deposit successful! You have been automatically enrolled in the ${plan.name} plan.\n\nYour investment of $${investmentAmount.toLocaleString()} has been allocated to your portfolio.`);
        } else if (plan) {
          alert(`Deposit successful! However, you need at least $${plan.monthlyAmount.toLocaleString()} to enroll in the ${plan.name} plan. Your current balance is $${newBalance.toLocaleString()}. Please deposit more funds.`);
        } else {
          alert('Deposit successful!');
        }

        // Clean and validate update data - ensure all values are valid numbers
        const cleanUpdateData = {
          profits: parseFloat(updateData.profits) || 0
        };
        
        // Add investment plan if it exists
        if (updateData.investment_plan) {
          cleanUpdateData.investment_plan = updateData.investment_plan;
        }
        
        // Add all asset fields with valid numbers (already set in updateData above)
        ['btc', 'eth', 'dodge', 'usdt', 'xlm', 'xrp', 'shiba', 'ltc'].forEach(asset => {
          const value = parseFloat(updateData[asset]);
          cleanUpdateData[asset] = (isNaN(value) ? 0 : value);
        });

        // Verify Supabase is available
        if (!window.supabase) {
          alert('Database connection not available. Please refresh the page and try again.');
          return;
        }

        console.log('Updating profile with:', cleanUpdateData);
        console.log('User ID:', session.user.id);
        console.log('Clean update data type check:', {
          profits: typeof cleanUpdateData.profits,
          btc: typeof cleanUpdateData.btc,
          eth: typeof cleanUpdateData.eth
        });

        // Verify profile exists before updating (or create it if it doesn't)
        const { data: verifyProfile, error: verifyError } = await window.supabase
          .from('profiles')
          .select('id')
          .eq('id', session.user.id)
          .single();

        if (verifyError) {
          if (verifyError.code === 'PGRST116' || verifyError.message?.includes('No rows')) {
            // Profile doesn't exist, create it first
            console.log('Profile not found during verification, creating...');
            const { error: createError } = await window.supabase
              .from('profiles')
              .insert({
                id: session.user.id,
                profits: 0,
                btc: 0, eth: 0, dodge: 0, usdt: 0, xlm: 0, xrp: 0, shiba: 0, ltc: 0
              });
            
            if (createError) {
              console.error('Failed to create profile during verification:', createError);
              // Continue anyway - the update might still work with upsert
            } else {
              console.log('Profile created during verification');
            }
          } else {
            console.error('Profile verification failed:', verifyError);
            // Continue anyway - might be a permission issue but update could still work
          }
        }

        try {
          // Simple update without select (matches dashboard.html pattern)
          const { error: updateError } = await window.supabase
            .from('profiles')
            .update(cleanUpdateData)
            .eq('id', session.user.id);

          if (updateError) {
            console.error('Update error details:', {
              message: updateError.message,
              code: updateError.code,
              details: updateError.details,
              hint: updateError.hint
            });
            
            // If update fails, try to upsert instead (insert or update)
            console.log('Trying upsert as fallback...');
            const { error: upsertError } = await window.supabase
              .from('profiles')
              .upsert({
                id: session.user.id,
                ...cleanUpdateData
              }, {
                onConflict: 'id'
              });

            if (upsertError) {
              console.error('Upsert error details:', {
                message: upsertError.message,
                code: upsertError.code,
                details: upsertError.details,
                hint: upsertError.hint
              });
              
              // Last resort: try inserting if profile truly doesn't exist
              if (upsertError.code === 'PGRST116' || upsertError.message?.includes('No rows')) {
                console.log('Trying insert as last resort...');
                const { error: insertError } = await window.supabase
                  .from('profiles')
                  .insert({
                    id: session.user.id,
                    ...cleanUpdateData
                  });
                
                if (insertError) {
                  console.error('Insert error details:', {
                    message: insertError.message,
                    code: insertError.code,
                    details: insertError.details,
                    hint: insertError.hint
                  });
                  alert('Error updating balance: ' + (insertError.message || 'Unknown error') + '\n\nPlease check the browser console (F12) for more details.');
                  return;
                } else {
                  console.log('Profile inserted successfully');
                }
              } else {
                // Show detailed error to user
                const errorMsg = upsertError.message || 'Unknown error';
                const errorDetails = upsertError.details ? `\nDetails: ${upsertError.details}` : '';
                const errorHint = upsertError.hint ? `\nHint: ${upsertError.hint}` : '';
                alert('Error updating balance: ' + errorMsg + errorDetails + errorHint + '\n\nPlease check the browser console (F12) for more details.');
                return;
              }
            } else {
              console.log('Profile upserted successfully');
        }
      } else {
            console.log('Profile updated successfully');
          }
        } catch (updateErr) {
          console.error('Update exception:', updateErr);
          console.error('Exception stack:', updateErr.stack);
          alert('Error updating profile: ' + (updateErr.message || 'Unknown error') + '\n\nPlease check the browser console (F12) for more details.');
          return;
        }
        
        // Small delay to ensure database update completes before redirect
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Redirect to dashboard
        window.location.href = 'dashboard.html';
      } catch (error) {
        console.error('Error processing deposit:', error);
        alert('An error occurred. Please try again.');
      }
    }


    // Calculate asset allocation based on investment plan (converts USD to crypto quantities)
    async function calculateAssetAllocation(planType, amount) {
      const allocation = {
        btc: 0,
        eth: 0,
        dodge: 0,
        usdt: 0,
        xlm: 0,
        xrp: 0,
        shiba: 0,
        ltc: 0
      };

      // Define asset distribution percentages
      let distribution = {};
      if (planType === 'conservative') {
        // Conservative: 40% BTC, 30% ETH, 20% USDT, 10% LTC (stable assets)
        distribution = { btc: 0.40, eth: 0.30, usdt: 0.20, ltc: 0.10 };
      } else if (planType === 'aggressive') {
        // Aggressive: 25% BTC, 20% ETH, 15% DOGE, 15% SHIB, 10% XRP, 10% XLM, 5% LTC (volatile assets)
        distribution = { btc: 0.25, eth: 0.20, dodge: 0.15, shiba: 0.15, xrp: 0.10, xlm: 0.10, ltc: 0.05 };
      }

      // Fetch current prices and convert USD to crypto quantities
      try {
        const LCW_API_KEY = "4d740457-16d7-483f-8c63-0e3705c4bc7c";
        const assetSymbols = Object.keys(distribution).map(key => {
          const symbolMap = { btc: 'BTC', eth: 'ETH', dodge: 'DOGE', usdt: 'USDT', xlm: 'XLM', xrp: 'XRP', shiba: 'SHIB', ltc: 'LTC' };
          return symbolMap[key];
        });

        const res = await fetch("https://api.livecoinwatch.com/coins/map", {
          method: "POST",
          headers: { "content-type": "application/json", "x-api-key": LCW_API_KEY },
          body: JSON.stringify({
            currency: "USD",
            codes: assetSymbols,
            sort: "rank", order: "ascending", offset: 0, limit: assetSymbols.length, meta: true
          })
        });

        const priceData = await res.json();
        const priceMap = {};
        priceData.forEach(coin => {
          priceMap[coin.code] = coin.rate || 0;
        });

        // Convert USD amounts to crypto quantities
        Object.keys(distribution).forEach(asset => {
          const symbolMap = { btc: 'BTC', eth: 'ETH', dodge: 'DOGE', usdt: 'USDT', xlm: 'XLM', xrp: 'XRP', shiba: 'SHIB', ltc: 'LTC' };
          const symbol = symbolMap[asset];
          const usdAmount = amount * distribution[asset];
          const price = priceMap[symbol] || 1; // Default to 1 if price not found
          allocation[asset] = usdAmount / price;
        });
      } catch (error) {
        console.error('Error fetching prices for allocation:', error);
        // Fallback: store USD values (will be converted later)
        Object.keys(distribution).forEach(asset => {
          allocation[asset] = amount * distribution[asset];
        });
      }

      return allocation;
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    }
    
    function toggleMobileMenu() {
      const menu = document.querySelector('.navbar-menu');
      menu.classList.toggle('active');
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      feather.replace();
      
      // Check for selected plan from URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const planType = urlParams.get('plan');
      const planAmount = urlParams.get('amount');
      
      let selectedPlan = null;
      if (planType && planAmount) {
        // Get plan from URL params
        const planName = planType === 'conservative' ? 'Conservative Growth' : 'Aggressive Growth';
        selectedPlan = {
          type: planType,
          name: planName,
          monthlyAmount: parseFloat(planAmount)
        };
        localStorage.setItem('selectedPlan', JSON.stringify(selectedPlan));
      } else {
        // Check localStorage
        const storedPlan = localStorage.getItem('selectedPlan');
        if (storedPlan) {
          selectedPlan = JSON.parse(storedPlan);
        }
      }
      
      // If plan is selected, show notice and pre-fill amount
      if (selectedPlan) {
        const notice = document.getElementById('planNotice');
        const noticeText = document.getElementById('planNoticeText');
        const amountInput = document.getElementById('amount');
        
        notice.style.display = 'block';
        noticeText.textContent = `You selected the ${selectedPlan.name} plan. Please deposit at least $${selectedPlan.monthlyAmount.toLocaleString()} to enroll.`;
        amountInput.value = selectedPlan.monthlyAmount;
        amountInput.min = selectedPlan.monthlyAmount;
        
        // Add a note below the amount field
        const amountContainer = amountInput.closest('.row') || amountInput.parentElement;
        const tip = document.createElement('div');
        tip.className = 'tip';
        tip.style.color = '#667eea';
        tip.style.fontWeight = '600';
        tip.style.marginTop = '8px';
        tip.textContent = `Minimum required: $${selectedPlan.monthlyAmount.toLocaleString()} for ${selectedPlan.name} plan`;
        amountContainer.appendChild(tip);
      }
      
      // Re-render icons after dynamic content
      setTimeout(() => feather.replace(), 100);
    });
  </script>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const SUPABASE_URL = 'https://mxbzzkwryfifpzaotrhl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14Ynp6a3dyeWZpZnB6YW90cmhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjQ4MzEsImV4cCI6MjA3ODU0MDgzMX0.ot10C7-pxlkoizmk5bhc2Oe_zyJ4PoGWdTrS7P8Xm9I';
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
<script src="page-transitions.js"></script>
</body>
</html>

