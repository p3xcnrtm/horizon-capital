<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Investment Dashboard | Horizon Capital</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #f5f7fa;
      min-height: 100vh;
      padding-top: 72px;
      padding-bottom: 40px;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .dashboard-header h1 {
      color: var(--text-dark);
      font-size: 2rem;
      font-weight: 700;
    }
    .welcome-text {
      color: var(--text-gray);
      font-size: 0.95rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .stat-card.primary { border-left-color: #4f46e5; }
    .stat-card.success { border-left-color: #10b981; }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.info { border-left-color: #3b82f6; }
    .stat-label {
      color: var(--text-gray);
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stat-value {
      color: var(--text-dark);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .stat-change {
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .stat-change.positive { color: #10b981; }
    .stat-change.negative { color: #ef4444; }
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f1f5f9;
    }
    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-dark);
    }
    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }
    th {
      font-weight: 600;
      color: var(--text-gray);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tr:hover {
      background: #f8fafc;
    }
    .asset-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.75rem;
      margin-right: 10px;
    }
    .positive { color: #10b981; font-weight: 600; }
    .negative { color: #ef4444; font-weight: 600; }
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .action-btn {
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      color: white;
    }
    .action-btn.deposit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .action-btn.withdraw {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .action-btn.invest {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .portfolio-chart {
      height: 200px;
      margin-top: 20px;
    }
    .recent-activity {
      list-style: none;
    }
    .activity-item {
      padding: 16px 0;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      color: var(--primary-color);
    }
    .activity-details h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    .activity-details p {
      font-size: 0.8rem;
      color: var(--text-gray);
    }
    .activity-amount {
      font-weight: 700;
      color: var(--text-dark);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-gray);
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    @media (max-width: 968px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    @media (max-width: 600px) {
      .stat-value { font-size: 1.5rem; }
      .dashboard-header h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-brand">HORIZON</a>
      <ul class="navbar-menu">
        <li><a href="index.html" class="navbar-link">Home</a></li>
        <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="real-estate.html" class="navbar-link">Real Estate</a></li>
        <li><a href="stocks.html" class="navbar-link">Stocks</a></li>
        <li><a href="bonds.html" class="navbar-link">Bonds</a></li>
        <li><a href="crypto.html" class="navbar-link">Crypto</a></li>
        <li><button onclick="logout()" class="navbar-btn btn-danger" style="padding: 0.5rem 1.25rem; font-size: 0.875rem;">Logout</button></li>
      </ul>
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i data-feather="menu"></i>
      </button>
    </div>
  </nav>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div>
        <h1>Investment Dashboard</h1>
        <p class="welcome-text" id="welcomeText">Welcome back</p>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-label">
          <i data-feather="dollar-sign" style="width: 16px; height: 16px;"></i>
          Total Portfolio Value
        </div>
        <div class="stat-value" id="totalPortfolio">$0.00</div>
        <div class="stat-change positive" id="portfolioChange">
          <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
          <span>+0.5% today</span>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-label">
          <i data-feather="wallet" style="width: 16px; height: 16px;"></i>
          Available Balance
        </div>
        <div class="stat-value" id="balance">$0.00</div>
        <div class="stat-change">
          <i data-feather="arrow-up-right" style="width: 14px; height: 14px;"></i>
          <span>Ready to invest</span>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-label">
          <i data-feather="pie-chart" style="width: 16px; height: 16px;"></i>
          Total Investments
        </div>
        <div class="stat-value" id="totalInvestments">$0.00</div>
        <div class="stat-change positive">
          <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
          <span>Active positions</span>
        </div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-label">
          <i data-feather="bar-chart-2" style="width: 16px; height: 16px;"></i>
          Total Return
        </div>
        <div class="stat-value" id="totalReturn">+0.00%</div>
        <div class="stat-change positive">
          <i data-feather="arrow-up" style="width: 14px; height: 14px;"></i>
          <span>All time</span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card-header">
        <h3 class="card-title">Quick Actions</h3>
      </div>
      <div class="quick-actions">
        <a href="deposit.html" class="action-btn deposit">
          <i data-feather="plus-circle" style="width: 18px; height: 18px;"></i>
          Deposit
        </a>
        <a href="withdraw.html" class="action-btn withdraw">
          <i data-feather="minus-circle" style="width: 18px; height: 18px;"></i>
          Withdraw
        </a>
        <a href="investment-plans.html" class="action-btn invest">
          <i data-feather="trending-up" style="width: 18px; height: 18px;"></i>
          Invest Now
        </a>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="main-content">
      <!-- Portfolio Holdings -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Portfolio Holdings</h3>
          <span style="color: var(--text-gray); font-size: 0.875rem;" id="assetCount">0 assets</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Asset</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Value</th>
                <th>24h Change</th>
              </tr>
            </thead>
            <tbody id="assets-table">
              <tr>
                <td colspan="6" class="empty-state">
                  <i data-feather="pie-chart"></i>
                  <p>No holdings yet. Start investing to see your portfolio here.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar -->
      <div>
        <!-- Portfolio Distribution Chart -->
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-header">
            <h3 class="card-title">Portfolio Distribution</h3>
          </div>
          <div class="portfolio-chart">
            <canvas id="portfolioChart"></canvas>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
          </div>
          <ul class="recent-activity" id="recentActivity">
            <li class="activity-item">
              <div class="activity-info">
                <div class="activity-icon">
                  <i data-feather="user-plus" style="width: 20px; height: 20px;"></i>
                </div>
                <div class="activity-details">
                  <h4>Account Created</h4>
                  <p>Welcome to Horizon Capital</p>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  
 <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ---- Supabase client ----
  const SUPABASE_URL = 'https://mxbzzkwryfifpzaotrhl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14Ynp6a3dyeWZpZnB6YW90cmhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjQ4MzEsImV4cCI6MjA3ODU0MDgzMX0.ot10C7-pxlkoizmk5bhc2Oe_zyJ4PoGWdTrS7P8Xm9I';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---- Loader gate ----
  const gate = document.createElement('div');
  gate.style.cssText =
    'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:blur(3px);z-index:9999;font:600 16px/1.2 Inter,system-ui;color:#111;text-align:center;padding:16px';
  gate.innerHTML = 'Loading your dashboard…';
  document.body.appendChild(gate);

  // ---- Helpers ----
  const $ = (s) => document.querySelector(s);
  const fmtUSD = (n, min=2, max=2) => '$' + Number(n||0).toLocaleString('en-US',{minimumFractionDigits:min, maximumFractionDigits:max});
  if (window.feather) document.addEventListener('DOMContentLoaded', () => feather.replace());

  // ---- State ----
  let profile = null;
  let portfolioChart = null;
  const LCW_API_KEY = "4d740457-16d7-483f-8c63-0e3705c4bc7c";

  // ---- Bounded auth gate ----
  // 1) Try immediately
  (async function gateAuth() {
    try {
      const { data: { session } } = await supabase.auth.getSession();

      if (session?.user) {
        await proceed(session);
        return;
      }

      // 2) No session yet → wait briefly for a sign-in/hydration
      const { data: sub } = supabase.auth.onAuthStateChange(async (event, sess) => {
        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'INITIAL_SESSION') {
          if (sess?.user) {
            await proceed(sess);
            sub.subscription.unsubscribe();
          }
        }
      });

      // 3) Hard timeout: after 2000ms, if still no session, bounce to login
      setTimeout(async () => {
        const { data: { session: s2 } } = await supabase.auth.getSession();
        if (!s2?.user) {
          window.location.replace('login.html');
        }
      }, 2000);
    } catch (e) {
      console.error('Auth gate error:', e);
      // If something unexpected happens, go to login (no hanging)
      window.location.replace('login.html');
    }
  })();

 // ---- After we know we’re authenticated ----
async function proceed(session) {
  try {
    // Load profile (don’t block UI forever if it fails)
    try {
    const { data, error } = await supabase
  .from('profiles')
  .select('full_name,username,profits,btc,eth,dodge,usdt,xlm,xrp,shiba,ltc,last_login,trn_date')
  .eq('id', session.user.id)
  .single();



      if (error) console.warn('Profile load failed:', error.message);
      profile = data || {};
// Debug: see what we got
console.log('Profile fetched:', profile, 'error:', error?.message);

const balEl = document.getElementById('balance');
if (balEl) {
  const raw = profile?.profits;
  const profits = (typeof raw === 'number' && Number.isFinite(raw))
    ? raw
    : (Number.parseFloat(raw ?? 0) || 0);
  balEl.textContent = fmtUSD(profits);
}


    } catch (e) {
      console.warn('Profile exception:', e);
      profile = {};
    }

    // ✅ Use session to help hydrate header if DB name missing
    hydrateHeader(profile, session);
    startDashboard(profile);
  } finally {
    gate.remove();
  }
}

// UPDATED: take session for smarter fallback
function hydrateHeader(p, session) {
  const welcomeText = document.querySelector('#welcomeText');
  const meta = session?.user?.user_metadata || {};
  const name =
    (p?.full_name && p.full_name.trim()) ||
    (p?.username && p.username.trim()) ||
    (meta.full_name && meta.full_name.trim()) ||
    (session?.user?.email && session.user.email.split('@')[0]) ||
    'Investor';

  if (welcomeText) welcomeText.textContent = `Welcome back, ${name}`;
}

  function buildAssetsFromProfile(p) {
    return [
      { symbol:'BTC', name:'Bitcoin',  type:'Crypto', quantity:Number(p?.btc||0),   price:0, change:0 },
      { symbol:'ETH', name:'Ethereum', type:'Crypto', quantity:Number(p?.eth||0),   price:0, change:0 },
      { symbol:'DOGE',name:'Dogecoin', type:'Crypto', quantity:Number(p?.dodge||0), price:0, change:0 },
      { symbol:'USDT',name:'Tether',   type:'Crypto', quantity:Number(p?.usdt||0),  price:0, change:0 },
      { symbol:'XLM', name:'Stellar',  type:'Crypto', quantity:Number(p?.xlm||0),   price:0, change:0 },
      { symbol:'XRP', name:'XRP',      type:'Crypto', quantity:Number(p?.xrp||0),   price:0, change:0 },
      { symbol:'SHIB',name:'Shiba',    type:'Crypto', quantity:Number(p?.shiba||0), price:0, change:0 },
      { symbol:'LTC', name:'Litecoin', type:'Crypto', quantity:Number(p?.ltc||0),   price:0, change:0 },
    ];
  }

  function startDashboard(p) {
    // logout binds to Supabase signOut
    window.logout = async function () {
      await supabase.auth.signOut();
      window.location.replace('login.html');
    };
    // mobile menu
    window.toggleMobileMenu = function () {
      document.querySelector('.navbar-menu')?.classList.toggle('active');
    };
    if (window.feather) feather.replace();

    // recent activity
    const activityList = $('#recentActivity');
    if (activityList) {
      activityList.innerHTML = `
        <li class="activity-item">
          <div class="activity-info">
            <div class="activity-icon"><i data-feather="user-plus" style="width:20px;height:20px;"></i></div>
            <div class="activity-details">
              <h4>Account Created</h4>
              <p>${p?.trn_date ? new Date(p.trn_date).toLocaleDateString() : 'Welcome to Horizon Capital'}</p>
            </div>
          </div>
        </li>
        ${p?.last_login ? `
        <li class="activity-item">
          <div class="activity-info">
            <div class="activity-icon"><i data-feather="log-in" style="width:20px;height:20px;"></i></div>
            <div class="activity-details">
              <h4>Last Login</h4>
              <p>${new Date(p.last_login).toLocaleDateString()} at ${new Date(p.last_login).toLocaleTimeString()}</p>
            </div>
          </div>
        </li>` : '' }
      `;
      if (window.feather) feather.replace();
    }

    // balances + assets
    const balanceEl = $('#balance');
    const totalPortfolioEl = $('#totalPortfolio');
    const totalInvestmentsEl = $('#totalInvestments');
    const totalReturnEl = $('#totalReturn');
    const assetCountEl = $('#assetCount');
    let portfolioChart = null;

    const assets = buildAssetsFromProfile(p);

    async function fetchLivePrices() {
      try {
        const res = await fetch("https://api.livecoinwatch.com/coins/map", {
          method: "POST",
          headers: { "content-type": "application/json", "x-api-key": LCW_API_KEY },
          body: JSON.stringify({
            currency: "USD",
            codes: assets.map(a => a.symbol),
            sort: "rank", order: "ascending", offset: 0, limit: assets.length, meta: true
          })
        });
        const data = await res.json();
        data.forEach(coin => {
          const a = assets.find(x => x.symbol === coin.code);
          if (a) { a.price = coin.rate || 0; a.change = (coin.delta?.day ?? 0) * 100; }
        });
        render();
      } catch (e) {
        console.warn('Price fetch failed:', e);
        render(); // still render with zeros
      }
    }

function render() {
   console.log('render() running');
  const raw = p?.profits;
  const balance = (typeof raw === 'number' && Number.isFinite(raw))
    ? raw
    : (Number.parseFloat(raw ?? 0) || 0);

  const balanceEl = document.querySelector('#balance');
  if (balanceEl) balanceEl.textContent = fmtUSD(balance);

      const tbody = $('#assets-table');
      if (!tbody) return;
      tbody.innerHTML = '';

      const active = assets.filter(a => (a.quantity || 0) > 0);
      if (active.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <i data-feather="pie-chart"></i>
            <p>No holdings yet. Start investing to see your portfolio here.</p>
          </td></tr>`;
        if (window.feather) feather.replace();
        updateStats(0, balance);
        updateChart([]);
        if (assetCountEl) assetCountEl.textContent = '0 assets';
        return;
      }

      let totalVal = 0;
      active.forEach(a => {
        const val = a.quantity * a.price;
        totalVal += val;
        const changeClass = a.change >= 0 ? 'positive' : 'negative';
        const changeIcon = a.change >= 0 ? 'arrow-up' : 'arrow-down';
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>
              <div style="display:flex;align-items:center;">
                <div class="asset-icon">${a.symbol[0]}</div>
                <div>
                  <div style="font-weight:600;color:var(--text-dark);">${a.name}</div>
                  <div style="font-size:.8rem;color:var(--text-gray);">${a.symbol}</div>
                </div>
              </div>
            </td>
            <td><span style="padding:4px 8px;background:#f1f5f9;border-radius:6px;font-size:.8rem;">${a.type}</span></td>
            <td style="font-weight:600;">${Number(a.quantity).toLocaleString('en-US',{maximumFractionDigits:8})}</td>
            <td>${fmtUSD(a.price,2,4)}</td>
            <td style="font-weight:600;">${fmtUSD(val)}</td>
            <td class="${changeClass}">
              <div style="display:flex;align-items:center;gap:4px;">
                <i data-feather="${changeIcon}" style="width:14px;height:14px;"></i>${Math.abs(a.change).toFixed(2)}%
              </div>
            </td>
          </tr>
        `);
      });

      if (window.feather) feather.replace();
      if (assetCountEl) assetCountEl.textContent = `${active.length} asset${active.length!==1?'s':''}`;
      updateStats(totalVal, balance);
      updateChart(active);
    }

    function updateStats(totalInvestments, balance) {
      const totalPortfolio = totalInvestments + balance;
      const base = 1000;
      const pct = totalInvestments > 0 ? ((totalPortfolio - base)/base*100) : 0;

      $('#totalPortfolio').textContent = fmtUSD(totalPortfolio);
      $('#totalInvestments').textContent = fmtUSD(totalInvestments);
      $('#totalReturn').textContent = `${pct>=0?'+':''}${pct.toFixed(2)}%`;

      const wrap = $('#totalReturn')?.parentElement?.querySelector('.stat-change');
      if (wrap) { wrap.classList.toggle('positive', pct>=0); wrap.classList.toggle('negative', pct<0); }
    }

    function updateChart(active) {
      const ctx = document.getElementById('portfolioChart');
      if (!ctx) return;
      if (!active.length) { if (portfolioChart) portfolioChart.destroy(); return; }

      const labels = active.map(a => a.symbol);
      const values = active.map(a => a.quantity * a.price);
      const colors = ['#4f46e5','#10b981','#f59e0b','#3b82f6','#ef4444','#8b5cf6','#ec4899'];

      if (portfolioChart) {
        portfolioChart.data.labels = labels;
        portfolioChart.data.datasets[0].data = values;
        portfolioChart.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
        portfolioChart.update();
      } else {
        portfolioChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
          options: {
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false} }
          }
        });
      }
    }

    // initial + interval refresh
    fetchLivePrices();
    setInterval(fetchLivePrices, 60000);
  }
</script>


<script src="page-transitions.js"></script>
</body>
</html>

